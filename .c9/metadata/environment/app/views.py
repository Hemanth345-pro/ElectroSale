{"filter":false,"title":"views.py","tooltip":"/app/views.py","undoManager":{"mark":19,"position":19,"stack":[[{"start":{"row":418,"column":27},"end":{"row":418,"column":95},"action":"remove","lines":["https://slc1tivxdi.execute-api.us-east-1.amazonaws.com/stage1/export"],"id":30}],[{"start":{"row":418,"column":27},"end":{"row":418,"column":105},"action":"insert","lines":["https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda"],"id":31}],[{"start":{"row":419,"column":63},"end":{"row":420,"column":0},"action":"insert","lines":["",""],"id":32},{"start":{"row":420,"column":0},"end":{"row":420,"column":8},"action":"insert","lines":["        "]},{"start":{"row":420,"column":8},"end":{"row":420,"column":9},"action":"insert","lines":["p"]},{"start":{"row":420,"column":9},"end":{"row":420,"column":10},"action":"insert","lines":["r"]}],[{"start":{"row":420,"column":10},"end":{"row":420,"column":11},"action":"insert","lines":["i"],"id":33},{"start":{"row":420,"column":11},"end":{"row":420,"column":12},"action":"insert","lines":["n"]},{"start":{"row":420,"column":12},"end":{"row":420,"column":13},"action":"insert","lines":["t"]}],[{"start":{"row":420,"column":8},"end":{"row":420,"column":13},"action":"remove","lines":["print"],"id":34},{"start":{"row":420,"column":8},"end":{"row":420,"column":15},"action":"insert","lines":["print()"]}],[{"start":{"row":420,"column":14},"end":{"row":420,"column":16},"action":"insert","lines":["\"\""],"id":35}],[{"start":{"row":420,"column":15},"end":{"row":420,"column":16},"action":"insert","lines":["a"],"id":36},{"start":{"row":420,"column":16},"end":{"row":420,"column":17},"action":"insert","lines":["p"]},{"start":{"row":420,"column":17},"end":{"row":420,"column":18},"action":"insert","lines":["i"]}],[{"start":{"row":420,"column":18},"end":{"row":420,"column":19},"action":"insert","lines":[" "],"id":37},{"start":{"row":420,"column":19},"end":{"row":420,"column":20},"action":"insert","lines":["g"]},{"start":{"row":420,"column":20},"end":{"row":420,"column":21},"action":"insert","lines":["a"]},{"start":{"row":420,"column":21},"end":{"row":420,"column":22},"action":"insert","lines":["t"]},{"start":{"row":420,"column":22},"end":{"row":420,"column":23},"action":"insert","lines":["e"]},{"start":{"row":420,"column":23},"end":{"row":420,"column":24},"action":"insert","lines":["w"]},{"start":{"row":420,"column":24},"end":{"row":420,"column":25},"action":"insert","lines":["a"]},{"start":{"row":420,"column":25},"end":{"row":420,"column":26},"action":"insert","lines":["y"]}],[{"start":{"row":420,"column":26},"end":{"row":420,"column":27},"action":"insert","lines":[" "],"id":38},{"start":{"row":420,"column":27},"end":{"row":420,"column":28},"action":"insert","lines":["h"]},{"start":{"row":420,"column":28},"end":{"row":420,"column":29},"action":"insert","lines":["i"]},{"start":{"row":420,"column":29},"end":{"row":420,"column":30},"action":"insert","lines":["t"]}],[{"start":{"row":418,"column":27},"end":{"row":418,"column":105},"action":"remove","lines":["https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda"],"id":39},{"start":{"row":418,"column":27},"end":{"row":418,"column":105},"action":"insert","lines":["https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda"]}],[{"start":{"row":418,"column":27},"end":{"row":418,"column":105},"action":"remove","lines":["https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda"],"id":40},{"start":{"row":418,"column":27},"end":{"row":418,"column":105},"action":"insert","lines":["https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda"]}],[{"start":{"row":399,"column":0},"end":{"row":399,"column":2},"action":"insert","lines":["# "],"id":41},{"start":{"row":400,"column":0},"end":{"row":400,"column":2},"action":"insert","lines":["# "]},{"start":{"row":402,"column":0},"end":{"row":402,"column":2},"action":"insert","lines":["# "]},{"start":{"row":403,"column":0},"end":{"row":403,"column":2},"action":"insert","lines":["# "]},{"start":{"row":404,"column":0},"end":{"row":404,"column":2},"action":"insert","lines":["# "]},{"start":{"row":406,"column":0},"end":{"row":406,"column":2},"action":"insert","lines":["# "]},{"start":{"row":407,"column":0},"end":{"row":407,"column":2},"action":"insert","lines":["# "]},{"start":{"row":408,"column":0},"end":{"row":408,"column":2},"action":"insert","lines":["# "]},{"start":{"row":409,"column":0},"end":{"row":409,"column":2},"action":"insert","lines":["# "]},{"start":{"row":410,"column":0},"end":{"row":410,"column":2},"action":"insert","lines":["# "]},{"start":{"row":411,"column":0},"end":{"row":411,"column":2},"action":"insert","lines":["# "]},{"start":{"row":412,"column":0},"end":{"row":412,"column":2},"action":"insert","lines":["# "]},{"start":{"row":413,"column":0},"end":{"row":413,"column":2},"action":"insert","lines":["# "]},{"start":{"row":414,"column":0},"end":{"row":414,"column":2},"action":"insert","lines":["# "]},{"start":{"row":415,"column":0},"end":{"row":415,"column":2},"action":"insert","lines":["# "]},{"start":{"row":416,"column":0},"end":{"row":416,"column":2},"action":"insert","lines":["# "]},{"start":{"row":418,"column":0},"end":{"row":418,"column":2},"action":"insert","lines":["# "]},{"start":{"row":419,"column":0},"end":{"row":419,"column":2},"action":"insert","lines":["# "]},{"start":{"row":420,"column":0},"end":{"row":420,"column":2},"action":"insert","lines":["# "]},{"start":{"row":422,"column":0},"end":{"row":422,"column":2},"action":"insert","lines":["# "]},{"start":{"row":423,"column":0},"end":{"row":423,"column":2},"action":"insert","lines":["# "]},{"start":{"row":424,"column":0},"end":{"row":424,"column":2},"action":"insert","lines":["# "]},{"start":{"row":425,"column":0},"end":{"row":425,"column":2},"action":"insert","lines":["# "]},{"start":{"row":426,"column":0},"end":{"row":426,"column":2},"action":"insert","lines":["# "]},{"start":{"row":427,"column":0},"end":{"row":427,"column":2},"action":"insert","lines":["# "]},{"start":{"row":428,"column":0},"end":{"row":428,"column":2},"action":"insert","lines":["# "]},{"start":{"row":429,"column":0},"end":{"row":429,"column":2},"action":"insert","lines":["# "]},{"start":{"row":431,"column":0},"end":{"row":431,"column":2},"action":"insert","lines":["# "]},{"start":{"row":432,"column":0},"end":{"row":432,"column":2},"action":"insert","lines":["# "]}],[{"start":{"row":433,"column":0},"end":{"row":434,"column":0},"action":"insert","lines":["",""],"id":42},{"start":{"row":434,"column":0},"end":{"row":435,"column":0},"action":"insert","lines":["",""]},{"start":{"row":435,"column":0},"end":{"row":436,"column":0},"action":"insert","lines":["",""]},{"start":{"row":436,"column":0},"end":{"row":437,"column":0},"action":"insert","lines":["",""]},{"start":{"row":437,"column":0},"end":{"row":438,"column":0},"action":"insert","lines":["",""]},{"start":{"row":438,"column":0},"end":{"row":439,"column":0},"action":"insert","lines":["",""]},{"start":{"row":439,"column":0},"end":{"row":440,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":438,"column":0},"end":{"row":477,"column":0},"action":"insert","lines":["class ExportToCSV(LoginRequiredMixin, View):","    login_url = '/'","","    def get(self, request, *args, **kwargs):","        sales = Sale.objects.all()","        sales_data = list(sales.values('id', 'product__name', 'quantity', 'total_price', 'sale_date'))","","        payload = {","            'sales': [","                {","                    'id': s['id'],","                    'product': s['product__name'],","                    'quantity': s['quantity'],","                    'total_price': float(s['total_price']),","                    'sale_date': s['sale_date'].strftime('%Y-%m-%d')","                } for s in sales_data","            ]","        }","","        api_gateway_url = \"https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda\"","        response = requests.post(api_gateway_url, json=payload)","","        print(\"API Gateway hit → Status:\", response.status_code)","","        if response.status_code == 200:","            result = response.json()","            body = json.loads(result[\"body\"])     # <---- FIXED","            file_url = body.get(\"download_url\")","            print(\"Download URL:\", file_url)","","            if file_url:","                messages.success(request, \"Sales export completed successfully. Check email.\")","            else:","                messages.error(request, \"Export completed but no download link returned.\")","","        else:","            messages.error(request, \"Failed to export sales CSV.\")","","        return redirect('admin_sales_history')",""],"id":43}],[{"start":{"row":438,"column":0},"end":{"row":438,"column":2},"action":"insert","lines":["# "],"id":44},{"start":{"row":439,"column":0},"end":{"row":439,"column":2},"action":"insert","lines":["# "]},{"start":{"row":441,"column":0},"end":{"row":441,"column":2},"action":"insert","lines":["# "]},{"start":{"row":442,"column":0},"end":{"row":442,"column":2},"action":"insert","lines":["# "]},{"start":{"row":443,"column":0},"end":{"row":443,"column":2},"action":"insert","lines":["# "]},{"start":{"row":445,"column":0},"end":{"row":445,"column":2},"action":"insert","lines":["# "]},{"start":{"row":446,"column":0},"end":{"row":446,"column":2},"action":"insert","lines":["# "]},{"start":{"row":447,"column":0},"end":{"row":447,"column":2},"action":"insert","lines":["# "]},{"start":{"row":448,"column":0},"end":{"row":448,"column":2},"action":"insert","lines":["# "]},{"start":{"row":449,"column":0},"end":{"row":449,"column":2},"action":"insert","lines":["# "]},{"start":{"row":450,"column":0},"end":{"row":450,"column":2},"action":"insert","lines":["# "]},{"start":{"row":451,"column":0},"end":{"row":451,"column":2},"action":"insert","lines":["# "]},{"start":{"row":452,"column":0},"end":{"row":452,"column":2},"action":"insert","lines":["# "]},{"start":{"row":453,"column":0},"end":{"row":453,"column":2},"action":"insert","lines":["# "]},{"start":{"row":454,"column":0},"end":{"row":454,"column":2},"action":"insert","lines":["# "]},{"start":{"row":455,"column":0},"end":{"row":455,"column":2},"action":"insert","lines":["# "]},{"start":{"row":457,"column":0},"end":{"row":457,"column":2},"action":"insert","lines":["# "]},{"start":{"row":458,"column":0},"end":{"row":458,"column":2},"action":"insert","lines":["# "]},{"start":{"row":460,"column":0},"end":{"row":460,"column":2},"action":"insert","lines":["# "]},{"start":{"row":462,"column":0},"end":{"row":462,"column":2},"action":"insert","lines":["# "]},{"start":{"row":463,"column":0},"end":{"row":463,"column":2},"action":"insert","lines":["# "]},{"start":{"row":464,"column":0},"end":{"row":464,"column":2},"action":"insert","lines":["# "]},{"start":{"row":465,"column":0},"end":{"row":465,"column":2},"action":"insert","lines":["# "]},{"start":{"row":466,"column":0},"end":{"row":466,"column":2},"action":"insert","lines":["# "]},{"start":{"row":468,"column":0},"end":{"row":468,"column":2},"action":"insert","lines":["# "]},{"start":{"row":469,"column":0},"end":{"row":469,"column":2},"action":"insert","lines":["# "]},{"start":{"row":470,"column":0},"end":{"row":470,"column":2},"action":"insert","lines":["# "]},{"start":{"row":471,"column":0},"end":{"row":471,"column":2},"action":"insert","lines":["# "]},{"start":{"row":473,"column":0},"end":{"row":473,"column":2},"action":"insert","lines":["# "]},{"start":{"row":474,"column":0},"end":{"row":474,"column":2},"action":"insert","lines":["# "]},{"start":{"row":476,"column":0},"end":{"row":476,"column":2},"action":"insert","lines":["# "]}],[{"start":{"row":480,"column":0},"end":{"row":558,"column":0},"action":"insert","lines":["import json","import requests","from django.contrib import messages","from django.shortcuts import redirect","from django.views import View","from django.contrib.auth.mixins import LoginRequiredMixin","from app.models import Sale","","","class ExportToCSV(LoginRequiredMixin, View):","    login_url = '/'","","    def get(self, request, *args, **kwargs):","","        # Get all sales","        sales = Sale.objects.all()","        sales_data = list(sales.values(","            'id', ","            'product__name', ","            'quantity', ","            'total_price', ","            'sale_date'","        ))","","        # Build payload for Lambda","        payload = {","            'sales': [","                {","                    'id': s['id'],","                    'product': s['product__name'],","                    'quantity': s['quantity'],","                    'total_price': float(s['total_price']),","                    'sale_date': s['sale_date'].strftime('%Y-%m-%d')","                }","                for s in sales_data","            ]","        }","","        api_gateway_url = (","            \"https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/\"","            \"stage1/x22183744-lambda\"","        )","","        # IMPORTANT: Add content-type header","        headers = {\"Content-Type\": \"application/json\"}","","        # Call API Gateway → Lambda","        response = requests.post(api_gateway_url, json=payload, headers=headers)","","        print(\"API Gateway hit → Status:\", response.status_code)","","        if response.status_code == 200:","            try:","                # DIRECT JSON from Lambda (NO need result[\"body\"])","                response_json = response.json()","                print(\"Lambda Response:\", response_json)","","                download_url = response_json.get(\"download_url\")","","                if download_url:","                    print(\"Download URL:\", download_url)","                    messages.success(","                        request,","                        \"Sales export completed successfully. \"","                        \"Check your email for download link.\"","                    )","                else:","                    messages.error(request, \"Export completed but no URL returned.\")","","            except Exception as e:","                print(\"JSON parsing error →\", e)","                messages.error(request, \"Error reading Lambda response.\")","","        else:","            print(\"API Error →\", response.text)","            messages.error(request, \"Failed to export sales CSV.\")","","        return redirect('admin_sales_history')",""],"id":45}],[{"start":{"row":558,"column":0},"end":{"row":559,"column":0},"action":"insert","lines":["",""],"id":46},{"start":{"row":559,"column":0},"end":{"row":560,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":436,"column":0},"end":{"row":479,"column":0},"action":"remove","lines":["","","# class ExportToCSV(LoginRequiredMixin, View):","#     login_url = '/'","","#     def get(self, request, *args, **kwargs):","#         sales = Sale.objects.all()","#         sales_data = list(sales.values('id', 'product__name', 'quantity', 'total_price', 'sale_date'))","","#         payload = {","#             'sales': [","#                 {","#                     'id': s['id'],","#                     'product': s['product__name'],","#                     'quantity': s['quantity'],","#                     'total_price': float(s['total_price']),","#                     'sale_date': s['sale_date'].strftime('%Y-%m-%d')","#                 } for s in sales_data","#             ]","#         }","","#         api_gateway_url = \"https://ij536t0z4k.execute-api.us-east-1.amazonaws.com/stage1/x22183744-lambda\"","#         response = requests.post(api_gateway_url, json=payload)","","#         print(\"API Gateway hit → Status:\", response.status_code)","","#         if response.status_code == 200:","#             result = response.json()","#             body = json.loads(result[\"body\"])     # <---- FIXED","#             file_url = body.get(\"download_url\")","#             print(\"Download URL:\", file_url)","","#             if file_url:","#                 messages.success(request, \"Sales export completed successfully. Check email.\")","#             else:","#                 messages.error(request, \"Export completed but no download link returned.\")","","#         else:","#             messages.error(request, \"Failed to export sales CSV.\")","","#         return redirect('admin_sales_history')","","",""],"id":47}],[{"start":{"row":51,"column":4},"end":{"row":51,"column":18},"action":"remove","lines":["file_upload_s3"],"id":48},{"start":{"row":51,"column":4},"end":{"row":51,"column":13},"action":"insert","lines":["s3_upload"]},{"start":{"row":197,"column":16},"end":{"row":197,"column":30},"action":"remove","lines":["file_upload_s3"]},{"start":{"row":197,"column":16},"end":{"row":197,"column":25},"action":"insert","lines":["s3_upload"]},{"start":{"row":210,"column":12},"end":{"row":210,"column":26},"action":"remove","lines":["file_upload_s3"]},{"start":{"row":210,"column":12},"end":{"row":210,"column":21},"action":"insert","lines":["s3_upload"]}],[{"start":{"row":22,"column":4},"end":{"row":22,"column":18},"action":"remove","lines":["send_email_sns"],"id":49},{"start":{"row":22,"column":4},"end":{"row":22,"column":18},"action":"insert","lines":["send_sns_email"]},{"start":{"row":348,"column":16},"end":{"row":348,"column":30},"action":"remove","lines":["send_email_sns"]},{"start":{"row":348,"column":16},"end":{"row":348,"column":30},"action":"insert","lines":["send_sns_email"]}]]},"ace":{"folds":[],"scrolltop":246.6666717529297,"scrollleft":0,"selection":{"start":{"row":37,"column":38},"end":{"row":37,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":17,"state":"start","mode":"ace/mode/python"}},"timestamp":1764155183916,"hash":"0d1327681e8858edd217ee4bf85c2459b99240ac"}